@startuml "Company-Analysis-Improved-Workflow"
title Vylepšený proces analýzy společnosti v dotazu

skinparam backgroundColor #EEEBDC
skinparam handwritten false
skinparam DefaultFontName "Arial"

' Definice účastníků
actor "Uživatel" as User
participant "route_query\n(graph_nodes.py)" as RouteQuery
participant "analyze_query_sync\n(analyzer.py)" as AnalyzeQuerySync
participant "analyze_company_query\n(analyzer.py)" as AnalyzeCompanyQuery
participant "prepare_company_query\n(graph_nodes.py)" as PrepareCompanyQuery
participant "retrieve_company_data\n(graph_nodes.py)" as RetrieveCompanyData
participant "LLM\n(Claude-3)" as LLM

' Proces
User -> RouteQuery : "Má MB TOOL nějaké sankce?"
activate RouteQuery

RouteQuery -> RouteQuery : Kontrola dotazu

alt Detekován konkrétní vzor "MB TOOL + sankce"
    RouteQuery -> AnalyzeCompanyQuery : Předběžná analýza
    activate AnalyzeCompanyQuery
    
    AnalyzeCompanyQuery -> LLM : Prompt s příklady
    activate LLM
    LLM --> AnalyzeCompanyQuery : "MB TOOL; risk_comparison"
    deactivate LLM
    
    AnalyzeCompanyQuery --> RouteQuery : (MB TOOL, risk_comparison)
    deactivate AnalyzeCompanyQuery
    
    RouteQuery --> RouteQuery : Uloží výsledek do state
    RouteQuery --> RouteQuery : query_type = "company"
else Standardní analýza
    RouteQuery -> AnalyzeQuerySync : Analyzuj dotaz
    activate AnalyzeQuerySync
    
    alt Přímý test pro známé společnosti
        AnalyzeQuerySync -> AnalyzeCompanyQuery : Kontrola pomocí LLM
        activate AnalyzeCompanyQuery
        AnalyzeCompanyQuery --> AnalyzeQuerySync : Rozpoznaná společnost
        deactivate AnalyzeCompanyQuery
    else Asynchronní analýza
        AnalyzeQuerySync -> AnalyzeQuerySync : Spusť analyze_query
        AnalyzeQuerySync --> AnalyzeQuerySync : Zpracuj výsledky
    end
    
    AnalyzeQuerySync --> RouteQuery : query_type
    deactivate AnalyzeQuerySync
end

RouteQuery --> PrepareCompanyQuery : Předání výsledku
deactivate RouteQuery

activate PrepareCompanyQuery
PrepareCompanyQuery -> PrepareCompanyQuery : Získání company_name z state

alt company_name == "Unknown"
    PrepareCompanyQuery -> AnalyzeCompanyQuery : Analýza dotazu pomocí LLM
    activate AnalyzeCompanyQuery
    AnalyzeCompanyQuery --> PrepareCompanyQuery : (company_name, analysis_type)
    deactivate AnalyzeCompanyQuery
    
    alt Stále "Unknown"
        PrepareCompanyQuery -> PrepareCompanyQuery : Regex analýza
        PrepareCompanyQuery -> PrepareCompanyQuery : Hledání slov s velkým písmenem
    end
end

PrepareCompanyQuery --> RetrieveCompanyData : Předání společnosti
deactivate PrepareCompanyQuery

activate RetrieveCompanyData
RetrieveCompanyData -> RetrieveCompanyData : Získej data společnosti
RetrieveCompanyData --> User : Výsledek analýzy
deactivate RetrieveCompanyData

@enduml
